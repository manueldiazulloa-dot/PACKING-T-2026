<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA PACKING T - CONTROL TOTAL</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --bg: #f4f7f6; --card: #ffffff; --text: #1a1a1a; --border: #cbd5e1; --primary: #2563eb; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        /* Botones de men√∫ estilo ayer */
        .menu-btns { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-menu { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #e2e8f0; transition: 0.3s; }
        .btn-menu.active { background: var(--primary); color: white; }

        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid var(--primary); font-weight: bold; box-sizing: border-box; }
        label { font-size: 11px; font-weight: bold; color: #64748b; text-transform: uppercase; }

        .btn-save { width: 100%; padding: 15px; margin-top: 15px; border-radius: 8px; border: none; color: white; font-weight: bold; cursor: pointer; font-size: 16px; }
        .bg-green { background: #10b981; border-bottom: 4px solid #059669; }
        .bg-red { background: #ef4444; border-bottom: 4px solid #b91c1c; }

        /* Tabla e Informe */
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: var(--primary); color: white; padding: 12px; border: 1px solid #000; }
        td { padding: 10px; border: 1px solid var(--border); text-align: center; font-weight: bold; }
        
        .stock-alert { background: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; display: none; }
        .oculto { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h2>PACKING T - SISTEMA 2026</h2>
        <div style="display: flex; gap: 10px;">
            <button class="btn-menu" style="background:#6366f1; color:white;" onclick="exportarPDF()">üìÑ PDF EXISTENCIAS</button>
            <button class="btn-menu" style="background:#22c55e; color:white;" onclick="exportarExcel()">üìä EXCEL</button>
        </div>
    </div>

    <div id="alertaGeneral" class="stock-alert">
        ‚ö†Ô∏è ATENCI√ìN: Hay materiales bajo el stock m√≠nimo. Favor revisar la tabla.
    </div>

    <div class="menu-btns">
        <button id="btnE" class="btn-menu active" onclick="cambiarModo('ENTRADA')">üì• ENTRADAS</button>
        <button id="btnS" class="btn-menu" onclick="cambiarModo('SALIDA')">üì§ SALIDAS</button>
    </div>

    <div class="card">
        <h3 id="tituloForm">REGISTRO DE ENTRADA</h3>
        <div class="grid-form">
            <div><label>C√ìDIGO MATERIAL</label><input type="text" id="c_cod" oninput="verificar()"></div>
            <div id="divNom"><label>NOMBRE MATERIAL</label><input type="text" id="c_nom"></div>
            <div id="divMin"><label>STOCK M√çNIMO</label><input type="number" id="c_min" value="10"></div>
            <div><label>N¬∞ GU√çA</label><input type="text" id="c_guia"></div>
            <div><label>PATENTE</label><input type="text" id="c_patente"></div>
            <div><label>CHOFER</label><input type="text" id="c_chofer"></div>
            <div>
                <label id="lblUbicacion">PROCEDENCIA</label>
                <input type="text" id="c_ubicacion" placeholder="Origen...">
            </div>
            <div><label>CANTIDAD</label><input type="number" id="c_cant" style="border-width: 3px;"></div>
        </div>
        <button id="btnGuardar" class="btn-save bg-green" onclick="guardar()">GUARDAR ENTRADA</button>
    </div>

    <div class="card">
        <h3>üìã EXISTENCIA ACTUAL DE BODEGA</h3>
        <table>
            <thead>
                <tr>
                    <th>MATERIAL</th>
                    <th>ENTRADAS</th>
                    <th>SALIDAS</th>
                    <th>STOCK REAL</th>
                    <th>M√çNIMO</th>
                </tr>
            </thead>
            <tbody id="listaBody"></tbody>
        </table>
    </div>

    <script>
        let inventario = JSON.parse(localStorage.getItem('packing_v6_2026')) || [];
        let modoActual = 'ENTRADA';

        function cambiarModo(modo) {
            modoActual = modo;
            document.getElementById('btnE').classList.toggle('active', modo === 'ENTRADA');
            document.getElementById('btnS').classList.toggle('active', modo === 'SALIDA');
            document.getElementById('tituloForm').innerText = 'REGISTRO DE ' + modo;
            document.getElementById('btnGuardar').innerText = 'GUARDAR ' + modo;
            document.getElementById('btnGuardar').className = 'btn-save ' + (modo === 'ENTRADA' ? 'bg-green' : 'bg-red');
            document.getElementById('lblUbicacion').innerText = (modo === 'ENTRADA' ? 'PROCEDENCIA' : 'DESTINO');
            verificar();
        }

        function verificar() {
            const cod = document.getElementById('c_cod').value.trim();
            const existe = inventario.find(i => i.codigo === cod);
            document.getElementById('divNom').classList.toggle('oculto', !!existe);
            document.getElementById('divMin').classList.toggle('oculto', !!existe);
        }

        function guardar() {
            const cod = document.getElementById('c_cod').value.trim();
            const q = parseInt(document.getElementById('c_cant').value) || 0;
            if(!cod || q <= 0) return alert("Faltan datos");

            let i = inventario.findIndex(item => item.codigo === cod);

            if(i !== -1) {
                if(modoActual === 'SALIDA') {
                    if(inventario[i].real < q) return alert("Stock insuficiente");
                    inventario[i].salidas += q;
                    inventario[i].real -= q;
                } else {
                    inventario[i].entradas += q;
                    inventario[i].real += q;
                }
            } else {
                const nom = document.getElementById('c_nom').value;
                const min = parseInt(document.getElementById('c_min').value) || 0;
                inventario.push({codigo:cod, nombre:nom, entradas:q, salidas:0, real:q, minimo:min});
            }

            localStorage.setItem('packing_v6_2026', JSON.stringify(inventario));
            location.reload();
        }

        function render() {
            const b = document.getElementById('listaBody');
            let bajoStock = false;
            b.innerHTML = "";
            inventario.forEach(i => {
                const alerta = i.real <= i.minimo;
                if(alerta) bajoStock = true;
                b.innerHTML += `<tr style="${alerta ? 'background:#fee2e2' : ''}">
                    <td>${i.codigo} - ${i.nombre}</td>
                    <td>${i.entradas}</td>
                    <td>${i.salidas}</td>
                    <td style="color:${alerta ? 'red' : 'green'}">${i.real}</td>
                    <td>${i.minimo}</td>
                </tr>`;
            });
            if(bajoStock) document.getElementById('alertaGeneral').style.display = 'block';
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("INFORME DE EXISTENCIAS - PACKING T", 14, 15);
            doc.autoTable({
                head: [['Material', 'Entradas', 'Salidas', 'Stock Real']],
                body: inventario.map(i => [i.codigo + " " + i.nombre, i.entradas, i.salidas, i.real])
            });
            doc.save("Existencias_PackingT.pdf");
        }

        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(inventario);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Bodega");
            XLSX.writeFile(wb, "Reporte_Inventario.xlsx");
        }

        render();
    </script>
</body>
</html>
