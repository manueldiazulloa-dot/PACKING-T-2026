<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA INTEGRAL PACKING T 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --bg: #f0f2f5; --card: #ffffff; --text: #1e293b; --border: #cbd5e1; }
        [data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; }
        
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; transition: 0.3s; }
        .container { max-width: 1000px; margin: auto; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 20px; }
        
        h2, h3 { margin-top: 0; color: #2563eb; }
        [data-theme="dark"] h2, [data-theme="dark"] h3 { color: #38bdf8; }

        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--card); color: var(--text); box-sizing: border-box; font-size: 16px; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.2s; }
        .btn-in { background: #10b981; border-bottom: 4px solid #059669; }
        .btn-out { background: #ef4444; border-bottom: 4px solid #b91c1c; }
        .btn-pdf { background: #6366f1; border-bottom: 4px solid #4338ca; }
        .btn-xl { background: #22c55e; border-bottom: 4px solid #16a34a; }
        .btn:active { transform: translateY(2px); border-bottom: 0; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--card); }
        th { background: #2563eb; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid var(--border); }
        
        .alert-low { color: #ef4444; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .oculto { display: none; }
        .header-tools { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    </style>
</head>
<body data-theme="light">

<div class="container">
    <div class="header-tools">
        <h2>üì¶ PACKING T - CONTROL 2026</h2>
        <button onclick="toggleTheme()" class="btn" style="background:#475569; width:auto; padding:8px 15px;">üåì MODO</button>
    </div>

    <div class="card">
        <h3>üîç AUDITOR√çA DE GU√çAS</h3>
        <div class="grid-form">
            <select id="selGuia" onchange="actualizarAuditoria()">
                <option value="">-- SELECCIONE GU√çA --</option>
                <option value="234567">Gu√≠a: 234567 (Entrada)</option>
                <option value="987654">Gu√≠a: 987654 (Salida)</option>
            </select>
            <button class="btn btn-pdf" onclick="imprimirAuditoria()">üìÑ IMPRIMIR GU√çA (PDF)</button>
        </div>
        <div id="resAud" style="margin-top:15px; padding:10px; border-left:4px solid #2563eb; background:rgba(37,99,235,0.1);">
            Seleccione una gu√≠a para ver detalles...
        </div>
    </div>

    <div class="card">
        <h3>üì• / üì§ MOVIMIENTOS DE BODEGA</h3>
        <div class="grid-form">
            <div>
                <label>C√≥digo del Material</label>
                <input type="text" id="c_cod" oninput="chequearExistencia()" placeholder="Ej: AGR 1">
            </div>
            <div id="fieldNom">
                <label>Nombre</label>
                <input type="text" id="c_nom">
            </div>
            <div id="fieldMin">
                <label>Stock M√≠nimo</label>
                <input type="number" id="c_min" value="10">
            </div>
            <div>
                <label id="lblCant">Cantidad</label>
                <input type="number" id="c_cant" placeholder="0">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-in" onclick="procesar('ENTRADA')">‚ûï ENTRADA</button>
            <button class="btn btn-out" onclick="procesar('SALIDA')">‚ûñ SALIDA</button>
        </div>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>üìã EXISTENCIA ACTUAL</h3>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-pdf" onclick="exportarPDF()">üìÑ PDF</button>
                <button class="btn btn-xl" onclick="exportarExcel()">üìä EXCEL</button>
            </div>
        </div>
        <table id="tablaInventario">
            <thead>
                <tr>
                    <th>MATERIAL</th>
                    <th>ENTRADAS</th>
                    <th>SALIDAS</th>
                    <th>STOCK REAL</th>
                </tr>
            </thead>
            <tbody id="listaBody"></tbody>
        </table>
    </div>
</div>

<script>
    let db = JSON.parse(localStorage.getItem('db_packing_2026')) || [];

    function toggleTheme() {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    function chequearExistencia() {
        const cod = document.getElementById('c_cod').value.trim();
        const existe = db.find(i => i.codigo === cod);
        
        if(existe) {
            document.getElementById('fieldNom').classList.add('oculto');
            document.getElementById('fieldMin').classList.add('oculto');
            document.getElementById('lblCant').innerText = "CANTIDAD A MOVER";
        } else {
            document.getElementById('fieldNom').classList.remove('oculto');
            document.getElementById('fieldMin').classList.remove('oculto');
            document.getElementById('lblCant').innerText = "STOCK INICIAL";
        }
    }

    function procesar(tipo) {
        const cod = document.getElementById('c_cod').value.trim();
        const cant = parseInt(document.getElementById('c_cant').value) || 0;
        if(!cod || cant <= 0) return alert("Ingrese c√≥digo y cantidad v√°lida");

        let i = db.findIndex(item => item.codigo === cod);

        if(i !== -1) {
            if(tipo === 'ENTRADA') {
                db[i].entradas += cant;
                db[i].real += cant;
            } else {
                if(db[i].real < cant) return alert("¬°Error! Stock insuficiente para esta salida.");
                db[i].salidas += cant;
                db[i].real -= cant;
            }
        } else {
            // Nuevo Material
            const nom = document.getElementById('c_nom').value || "S/N";
            const min = parseInt(document.getElementById('c_min').value) || 0;
            db.push({
                codigo: cod, nombre: nom, 
                entradas: tipo === 'ENTRADA' ? cant : 0,
                salidas: tipo === 'SALIDA' ? cant : 0,
                minimo: min, real: cant
            });
        }
        
        saveAndReload();
    }

    function saveAndReload() {
        localStorage.setItem('db_packing_2026', JSON.stringify(db));
        render();
        document.getElementById('c_cod').value = "";
        document.getElementById('c_cant').value = "";
        chequearExistencia();
    }

    function render() {
        const body = document.getElementById('listaBody');
        body.innerHTML = "";
        db.forEach(item => {
            const isLow = item.real <= item.minimo;
            body.innerHTML += `
                <tr>
                    <td><strong>${item.codigo}</strong> - ${item.nombre}</td>
                    <td>${item.entradas}</td>
                    <td>${item.salidas}</td>
                    <td class="${isLow ? 'alert-low' : ''}">${item.real} ${isLow ? '‚ö†Ô∏è' : ''}</td>
                </tr>`;
        });
    }

    // --- FUNCIONES DE EXPORTACI√ìN ---

    function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("PACKING T - INFORME DE EXISTENCIAS 2026", 14, 15);
        
        const rows = db.map(i => [i.codigo + " " + i.nombre, i.entradas, i.salidas, i.real]);
        doc.autoTable({
            head: [['Material', 'Entradas', 'Salidas', 'Stock Real']],
            body: rows,
            startY: 25
        });
        doc.save("Existencias_PackingT.pdf");
    }

    function exportarExcel() {
        const worksheet = XLSX.utils.json_to_sheet(db);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
        XLSX.writeFile(workbook, "Inventario_PackingT_2026.xlsx");
    }

    function actualizarAuditoria() {
        const g = document.getElementById('selGuia').value;
        const box = document.getElementById('resAud');
        if(g === '234567') box.innerHTML = "<strong>TIPO: ENTRADA</strong><br>Material: ESQUINEROS CART√ìN<br>Cantidad: 3000<br>Origen: Proveedor Central";
        else if(g === '987654') box.innerHTML = "<strong>TIPO: SALIDA</strong><br>Material: CINTA EMBALAJE<br>Cantidad: 50<br>Destino: L√≠nea de Producci√≥n 2";
        else box.innerHTML = "Seleccione una gu√≠a...";
    }

    function imprimirAuditoria() {
        const g = document.getElementById('selGuia').value;
        if(!g) return alert("Seleccione una gu√≠a");
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("AUDITOR√çA DE GU√çA: " + g, 14, 20);
        doc.text(document.getElementById('resAud').innerText, 14, 40);
        doc.save("Auditoria_Guia_" + g + ".pdf");
    }

    render();
</script>
</body>
</html>
